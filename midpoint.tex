\newcommand{\yhf}{\hat{\yv}_n}
\newcommand{\dfdy}{F}


\section{An adaptive midpoint method time integrator}

%** intro

%*** other names?

%*** Banas' work

%** midpoint vs bdf2 vs trapazoid rule in micromagnetics

%** Adaptive scheme types, total error, spatial errors, LTE

%** The maths (standard rule, definitions)

\subsection{Standard midpoint method}

Let $\yv(t)$ be a vector function of time, let $\yv_n$ denote a vector of estimates to $\yv(t)$ with $t = t_n$.
Let $\dtn = t_{n+1} - t_n$ be the time step.
Then given a system of equations of the form
\begin{equation}
  \pd{\yv(t)}{t} = \fv(t, \yv(t)),
\end{equation}
the midpoint method is given by
\begin{equation}
  \yv_{n+1} = \yv_n + \dtn \fv(\frac{t_n + t_{n+1}}{2}, \frac{\yv_n + \yv_{n+1}}{2}).
  \label{eq:basic-midpoint}
\end{equation}
Note that this is valid for both constant and non-constant times (\cf BDF2, AB2 which change).

However, commonly we wish to solve a system of equations where $ \pd{\yv(t)}{t}$ is only given implicitly.
For example the Gilbert form of the Landau-Lifshitz-Gilbert equation is given by
\begin{equation}
  \llg
\end{equation}
 In this case the equivalent to \eqref{eq:basic-midpoint} is to substitute by the following
\begin{align}
  \pd{\yv(t)}{t} & \simeq \frac{(\yv_{n+1} - \yv_n)}{\dtn}, \\
  \yv(t) & \simeq \frac{\yv_n + \yv_{n+1}}{2}, \notag \\
  t & \simeq \frac{t_n + t_{n+1}}{2}, \notag
\end{align}
\ie the derivative is estimated using standard finite differences and everything else is evaluated at the ``midpoint''.
This results in a system of equations which can be solved for $\yv_{n+1}$.

??ds how valid is the following for implicit cases?

\subsection{Derivation of local truncation errors}

The local truncation error (LTE) of a time integration scheme is the error due a single step of time integration.
It can be calculated by substituting the exact value for $\yv$ at the current time step into the approximation and subtracting a Taylor series expansion of the exact solution at the next time step.
An example for the forward Euler method is commonly given in basic textbooks but the calculation for the midpoint method is much more involved and so is given in full here.

To make the following derivation more readable we write:
\begin{align}
  \thf &= \frac{t_n + t_{n+1}}{2}, \notag\\
  \yhf &= \yv(\thf), \notag\\
\end{align}
and we denote derivatives of $\yv$ by $\yv'$ etc.

The local truncation error of the midpoint method is defined by
\begin{equation}
  T = \yv(t_{n+1}) - \yv(t_n) - \dtn \fv\left( \thf, \frac{\yv(t_n) + \yv_{n+1}}{2} \right).
  \label{eq:trunc-start}
\end{equation}

Assuming that $\yv(t)$ is sufficiently smooth its Taylor series expansion at $t_{n+1}$ about $\thf$ is given by
\begin{equation}
  \yv(t_{n+1}) = \yv(\thf + \frac{\dtn}{2}) = \yhf + \frac{\dtn}{2} \yhf' + \frac{\dtn^2}{8} \yhf'' + \frac{\dtn^3}{48} \yhf''' + \order{\dtn^4},
  \label{eq:taylornp1}
\end{equation}
where $\thf = (t_n + t_{n+1})/2$.
It is well known that the local truncation error of the midpoint method is $\order{\dtn^3}$ (\ie it is second order), so we can safely ignore $\order{\dtn^4}$ terms.
Similarly the expansion at $t_n$ is
\begin{equation}
  \yv(t_n) = \yv(\thf - \frac{\dtn}{2}) = \yhf - \frac{\dtn}{2} \yhf' + \frac{\dtn^2}{8} \yhf'' - \frac{\dtn^3}{48} \yhf''' + \order{\dtn^4}.
  \label{eq:taylorn}
\end{equation}

Substituting equations~\eqref{eq:taylornp1} and \eqref{eq:taylorn} into equation~\eqref{eq:trunc-start} gives
\begin{equation}
  T = \dtn \yhf' + \frac{\dtn^3}{24} \yhf'''
  - \dtn \fv\left( \thf, \frac{\yv(t_n) + \yv_{n+1}}{2} \right)  + \order{\dtn^4}.
  \label{eq:trunc-mid}
\end{equation}

Next we need to Taylor expand $\fv\left( \thf, \frac{\yv(t_n) + \yv_{n+1}}{2} \right)$ in $\yv$ about $\yhf$.
By definition $\fv(\thf, \yhf) = \yhf'$ so this will allow us to cancel terms.
Hence we need an expansion of the form
\begin{align}
 \fv(\thf, \frac{\yv(t_n) + \yv_{n+1}}{2}) &= \fv(\thf, \yhf + \dyn),
 \notag \\
 &= \fv(\thf, \yhf) + \dfdy(\thf, \yhf) \cdot \dyn  + \order{\dyn^2}
 \label{eq:f-taylor}
\end{align}
where $\dfdy$ is a \emph{matrix} of partial derivatives of each element of $\fv$ with respect to each element of the vector $\yv$ (\ie almost a Jacobian, except without the time derivative).
We use~'$\cdot$' here to denote matrix vector multiplication for clarity.
Note that the $\fv$ term is multiplied by an additional factor of $\dtn$ in \eqref{eq:trunc-start}, so for this part of the derivation we can drop terms of higher order than $\order{\dtn^2}$.

We now derive the required $\dyn$.
From equation~\eqref{eq:f-taylor} we have
\begin{equation}
  \dyn = \frac{\yv(t_n) + \yv_{n+1}}{2} - \yhf.
\end{equation}
However we already know that the LTE of midpoint method is $\order{\dtn^3}$, \ie $\yv_{n+1} = \yv(t_{n+1}) + \order{\dtn^3}$, so
\begin{equation}
   \dyn = \frac{\yv(t_n) + \yv(t_{n+1}) + \order{\dtn^3}}{2} - \yhf.
\end{equation}
Substituting in the Taylor expansions for $\yv(t_n)$ and $\yv(t_{n+1})$ about $\thf$ (from equations~\eqref{eq:taylornp1} and \eqref{eq:taylorn}) gives
\begin{align}
  \dyn &= \yhf + \frac{\dtn^2}{8} \yhf' + \order{\dtn^3} - \yhf \notag\\
  &= \frac{\dtn^2}{8} \yhf' + \order{\dtn^3}
\end{align}

Substituting this into Taylor series expansion of $\fv$ from \eqref{eq:f-taylor} gives
\begin{equation}
  \fv(\thf, \yhf + \dyn) = \yhf'
  + \frac{\dtn^2}{8} \dfdy(\thf, \yhf) \cdot \yhf' + \order{\dtn^3}
  , \label{eq:fy-taylor}
\end{equation}

Finally, substituting \eqref{eq:fy-taylor} into \eqref{eq:trunc-mid} gives the local truncation error
\begin{align}
  T &= \dtn \yhf' + \frac{\dtn^3}{24} \yhf'''
  - \dtn \yhf'
  - \frac{\dtn^3}{8} \dfdy(\thf, \yhf) \yhf' + \order{\dtn^4} \notag \\
  &\simeq \frac{\dtn^3}{24} \left[\yhf''' - 3 \dfdy(\thf, \yhf) \cdot \yhf' \right].
  \label{eq:trunc-final}
\end{align}

\subsection{Construction of an adaptive scheme}

In order to construct an adaptive time integration scheme we must find an easy to compute approximate to the local truncation error.
In this section we use a second order Adams-Bashforth method as a ``predictor'' in order to eliminate the difficult-to-estimate $\yhf'''$ term.\cite[p.274]{Gresho-Sani}
We also show that $\dfdy$ can be written in terms of the Jacobian of a Newton method applied to the problem.

\subsubsection{Elimination of the third derivative}
The second order variable time step Adam-Bashforth method is\cite{??ds}
\begin{equation}
  \yv_{n+1} = .
  \label{eq:AB2}
\end{equation}
Its local truncation error is\cite{??ds}
\begin{equation}
  T_{\text{AB2}} = .
  \label{eq:AB2LTE}
\end{equation}
%** AB2 + lte + citations

% derivations

% Why dfdy is ok


\subsection{Testing}

%*** Conservation properties

%*** stiffness

%*** Adaptivity effectiveness

\subsection{Future work}

%*** Does adaptivity trail off eventually like trapazoid?



%%% Local Variables:
%%% mode: latex
%%% TeX-master: "./main"
%%% End:
