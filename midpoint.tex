

\section{An adaptive implicit-midpoint-rule time-integrator}


%*** other names?

%% To make the following derivations more readable we write:
%% \begin{align}
%%   \thf &= \frac{t_n + t_{n+1}}{2}, \notag\\
%%   \yvhf &= \yv(\thf), %\notag\\
%%   %% \yvhfest &= \frac{\yv_{n+1} + \yv_n}{2},
%% \end{align}
%% and we denote derivatives of $\yv$ by $\yv'$ etc.


\subsection{Fixed step implicit midpoint rule}

Let $\yv(t)$ be a vector function, let $\yv_n$ denote a vector of estimates to $\yv(t)$ at $t = t_n$.
Let $\dtn = t_{n+1} - t_n$ be the step (or time-step).
Then given a system of equations of the form
\begin{equation}
  \yv'(t) = \fv(t, \yv(t)),
  \label{eq:43}
\end{equation}
the implicit midpoint rule (IMR) is
\begin{align}
  \yv_{n+1} &= \yv_n + \dtn \fv(\frac{t_{n+1} + t_n}{2}, \frac{\yv_n + \yv_{n+1}}{2}), \notag\\
  &= \yv_n + \dtn \fv(\thf, \frac{\yv_n + \yv_{n+1}}{2}),
  \label{eq:basic-midpoint}
\end{align}
where we have written
\begin{equation}
  \frac{t_{n+1} + t_n}{2} = \thf,
\end{equation}
for readability.

Note that unlike multistep methods, such as the second order backwards difference (BDF2), this is valid for both constant and variable step sizes because there is no dependence on previous steps.


\subsection{Derivation of local truncation error}
\label{sec:deriv-local-trunc}

The local truncation error (LTE) of a time integration scheme is the error due a single integration step.
It can be calculated by substituting $\yv_n = \yv(t_n)$ into the approximation for the next time-step then subtracting the result from the exact solution at the next time-step, $\yv(t_{n+1})$.

Using this definition the local truncation error of IMR is
\begin{align}
  \lte^\IMP &= \yv(t_{n+1}) - \yv_{n+1}^\IMP, \notag\\
  &= \yv(t_{n+1}) - \yv(t_n) - \dtn \fv\left( \thf, \frac{\yv(t_n) + \yv_{n+1}^\IMP}{2} \right).
  \label{eq:trunc-start}
\end{align}

We choose to Taylor expand everything about the midpoint, $\thf$, because it reduces the complexity of the result (and allows easier calculations).\footnote{If instead chose to expand about $t_n$ there would be an additional term in $\yv_n''$ in equation~\eqref{eq:trunc-mid}.}
We assume throughout that $\yv(t)$ is ``sufficiently smooth'' to have a Taylor series expansion. Then its Taylor series expansion at $t_{n+1}$ about $\thf$ is given by
\begin{equation}
  \yv(t_{n+1}) = \yv(\thf + \frac{\dtn}{2}) = \yvhf + \frac{\dtn}{2} \yvhf['] + \frac{\dtn^2}{8} \yvhf[''] + \frac{\dtn^3}{48} \yvhf['''] \porder{\dtn^4}.
  \label{eq:taylornp1}
\end{equation}
%% It is well known that the local truncation error of the midpoint rule is $\order{\dtn^3}$ (\ie it is second order)\cite{??ds}, so we can safely ignore $\order{\dtn^4}$ terms.
Similarly the expansion at $t_n$ is
\begin{equation}
  \yv(t_n) = \yv(\thf - \frac{\dtn}{2}) = \yvhf - \frac{\dtn}{2} \yvhf['] + \frac{\dtn^2}{8} \yvhf[''] - \frac{\dtn^3}{48} \yvhf['''] \porder{\dtn^4}.
  \label{eq:taylorn}
\end{equation}

Substituting equations~\eqref{eq:taylornp1} and \eqref{eq:taylorn} into equation~\eqref{eq:trunc-start} gives
\begin{equation}
  \lte^\IMP = \yv(t_{n+1}) - \yv_{n+1}^\IMP
  = \frac{\dtn^3}{24} \yvhf[''']  + \dtn  \left[ \yvhf[']
  - \fv\left( \thf, \frac{\yv(t_n) + \yv_{n+1}}{2} \right) \right]  \porder{\dtn^4}.
  \label{eq:trunc-mid}
\end{equation}

There are two parts to this error: the first term (with $\yv'''_n$) is fairly standard in second order time integrators.
However the second term is more complex, applying a Taylor expansion approach here would result in a Jacobian-like matrix of derivatives of $\fv$ with respect to $\yv$.
Hence we avoid expanding it further.
See Section~\ref{sec:full-imr-lte-calculation} for details of the rest of the Taylor expansion which proves that IMR is indeed a second order method.



\subsection{Construction of an adaptive scheme}

Most adaptive schemes for implicit integrators (e.g. trapezoid rule, BDF2) use a Milne-device based method.\cite{gresho-sani} % not sure what page
However due to the complexity of the local truncation error of the implicit midpoint rule there are some difficulties, see Section~??ds for more details.
Instead we take the approach commonly used in Runge-Kutta time integrators: we attempt to cheaply repeat the calculation at a higher accuracy and compare the answers to get an error estimate.
Such approaches usually rely on ``Runge-Kutta pairs'', pairs of RK methods which share a number of evaluation points but have different orders of accuracy.
Examples are ??ds RK45, RK23 \cite{??ds}

However IMR uses a single evaluation at the optimal point in the time step to cause cancellation of higher order terms.
Hence there is no way to reuse this evaluation in a higher order method without at least two additional evaluations, due to the destruction of symmetry.
Instead we use a little known explicit version of the third order backwards difference method (eBDF3).
This requires only 3 history values and a single (explicit) derivative function evaluation at time $t_n$ in order to compute a 3rd order accurate step.
Alternatively a 3rd order Adams-Bashforth scheme could be used, this would require one less startup step but would require storage of an additional derivative value.




\subsubsection{Computing the size of the next time-step}

We use a standard method for computing the next time step from the local truncation error and a target local truncation error \toltt:\cite[pg.268]{Gresho-Sani}
\begin{equation}
\dtx{n+1} = \dtn \left( \frac{\toltt}{\lte^\IMP}  \right) ^{\frac{1}{3}}
\end{equation}


\subsection{Numerical experiments}

To demonstrate the effectiveness of the adaptation scheme we use a simple ODE with known exact solution
\begin{align}
  f(t,y) &= - \beta e^{-\beta t} \sin(\omega t) + \omega e^{-\beta t} \cos(\omega t) \\
  y(0) &= 0
\end{align}
which gives the exact solution
\begin{equation}
  \label{eq:59}
  y(t) = e^{-\beta t} \sin(\omega t).
\end{equation}
The numerical experiments below all use $\omega = 2 \pi$ and $\beta = 0.3$.
The exact solution for this case is shown in Figure~\ref{fig:mp-ode-exact}.
Plots of the solutions given by the various numerical calculations below are all visually indistinguishable from Figure~\ref{fig:mp-ode-exact} (without zooming in) at the tolerances used, so they are not shown.

Unless otherwise specified all examples in this section use a Newton tolerance of $1\E{-8}$ and an adaptive integrator tolerance of $\toltt = 1\E{-4}$.

\begin{figure}[ht!]
  \centering
  \includegraphics{images/osc_damped_ode_exact}
  \caption{A plot of equation~\eqref{eq:59}, the exact solution of our example ODE.}
  \label{fig:mp-ode-exact}
\end{figure}

\begin{figure}[ht!]
  \centering
  \includegraphics{images/placeholder}
  \caption{Adaptive IMR vs adaptive BDF2 for a simple ODE.}
  \label{fig:mp-vs-bdf2}
\end{figure}

Figure~\ref{fig:mp-vs-bdf2} shows the performance of the adaptive midpoint scheme derived above compared to a standard adaptive BDF2 scheme.\cite{Gresho-Sani} %pg 715
The step size selection of the adaptive midpoint scheme closely follows that of the BDF2 scheme.


??ds discuss more about third derivative!
The pattern of step sizes is as expected.
There is a general trend of increasing step size as the solution is gradually damped out.
Additionally there is an oscillation which peaks at integer and half-integer times, this corresponds to the peaks in $\cos(\omega t)$ and $\sin(\omega t)$.
This is relevant because the truncation error is proportional to $y'''(t)$ which consists of terms in these two functions.

Also of note is that the accuracy of IMR is much higher than that of BDF2 for the same step size in this example.
??ds why? (Jacobian is zero)


Figure~\ref{fig:mp-tols} compares mean error norms and step sizes of the adaptive midpoint scheme (with two interpolation points) for varying tolerances.
The IMR can be seen to have quadratic convergence by comparing with the $y=x^2$ line shown.
Additionally it can be seen that decreasing the tolerance smoothly decreases the mean error (by smoothly decreasing the mean step size).

\begin{figure}[ht!]
  \centering
  \includegraphics{images/placeholder}
  \caption{Adaptive midpoint mean dt vs mean error for varying tolerance. The line is $y = x^2$.}
  \label{fig:mp-tols}
\end{figure}


\subsection{Additional Notes}

\subsubsection{Implicit ODEs}
\label{sec:extens-impl-odes}

We sometimes wish to solve a system of equations where $\yv'(t)$ only given implicitly\footnote{This use of ``implicit'' is unrelated to the notion of implicitness in the time integration scheme.} (for example the Gilbert form of the Landau-Lifshitz-Gilbert equation), in this case equation~\eqref{eq:43} becomes
\begin{equation}
  \fv(t, \yv(t), \yv'(t)) = 0.
\end{equation}

We note that equation~\eqref{eq:basic-midpoint} can also be written in the from
\begin{equation}
  \yv'(\thf) = \frac{\yv_{n+1} - \yv_n}{\dtn} =  \fv(\thf, \frac{\yv_n + \yv_{n+1}}{2}).
\end{equation}
So the obvious equivalent for IMR is
\begin{equation}
  \fv(\thf, \frac{\yv_{n+1} + \yv_n}{2}, \frac{\yv_{n+1} - \yv_n}{\dtn}) = 0.
\end{equation}

However the adaptive scheme requires an additional function evaluation.
For implicitly defined functions this is expensive, so this adaptive method is not efficient for equations which can only be defined in such a way.


\subsubsection{Full lte calculation of implicit midpoint}
\label{sec:full-imr-lte-calculation}

Continuing from equation~\eqref{eq:trunc-mid} at the end of Section~\ref{sec:deriv-local-trunc}.

In order to be able to cancel terms we now need to Taylor expand $\fv\left( \thf, \frac{\yv(t_n) + \yv_{n+1}}{2} \right)$ in $\yv$ about $\yvhf$.
Hence we need an expansion of the form
\begin{align}
  \fv(\thf, \frac{\yv(t_n) + \yv_{n+1}}{2}) &= \fv(\thf, \yvhf + \dyn),
  \notag \\
  &= \fv(\thf, \yvhf) + \dfdyhf \cdot \dyn  \porder{\dyn^2}
  \label{eq:f-taylor}
\end{align}
where $\dfdyhf = \dfdy(\thf, \yvhf)$ is a \emph{matrix} of partial derivatives of each element of $\fv$ with respect to each element of the vector $\yv$ (\ie almost a Jacobian, except without the time derivative).
Note that the $\fv$ term is multiplied by an additional factor of $\dtn$ in \eqref{eq:trunc-start}, so for this part of the derivation we can drop terms of higher order than $\order{\dtn^2}$ and still retain the same asymptotic accuracy.

We now derive the required correction $\dyn$.
From equation~\eqref{eq:f-taylor} we have
\begin{equation}
  \dyn = \frac{\yv(t_n) + \yv_{n+1}}{2} - \yvhf.
  \label{eq:51}
\end{equation}
However we cannot expand $\yv_{n+1}$ to get $\dyn$ in terms of only values at the midpoint.
So we use the LTE of IMR to rewrite equation~\eqref{eq:51} as
\begin{equation}
  \dyn = \frac{\yv(t_n) + \yv(t_{n+1}) - \lte^\IMP}{2} - \yvhf.
\end{equation}
Substituting in the Taylor expansions for $\yv(t_n)$ and $\yv(t_{n+1})$ about $\thf$ (from equations~\eqref{eq:taylornp1} and \eqref{eq:taylorn}) gives
\begin{align}
  \dyn &= \yvhf + \frac{\dtn^2}{8} \yvhf[''] - \yvhf - \frac{1}{2} \lte^\IMP \porder{\dtn^4} \notag\\
  &= \frac{\dtn^2}{8} \yvhf[''] - \frac{1}{2} \lte^\IMP \porder{\dtn^4}
  \label{eq:dy-value}
\end{align}



Substituting the above value for $\dyn$ into the Taylor series expansion of $\fv$ from \eqref{eq:f-taylor} gives
\begin{equation}
  \fv(\thf, \frac{\yv(t_n) + \yv_{n+1}}{2}) = \yvhf[']
  + \frac{\dtn^2}{8} \dfdyhf \cdot \yvhf[''] - \frac{1}{2} \dfdyhf \cdot \lte^\IMP \porder{\dtn^4}
  . \label{eq:fy-taylor}
\end{equation}
and using \eqref{eq:fy-taylor} in \eqref{eq:trunc-mid} gives the local truncation error
\begin{align}
  (I + \frac{\dtn}{2}\dfdyhf) \cdot\lte^\IMP
  &= \dtn \yvhf['] + \frac{\dtn^3}{24} \yvhf[''']
  - \dtn \yvhf[']
  - \frac{\dtn^3}{8} \dfdyhf \cdot \yvhf[''] \porder{\dtn^4}
  \notag \\
  &= \frac{\dtn^3}{24} \left[\yvhf['''] - 3 \dfdyhf \cdot \yvhf[''] \right]
  \porder{\dtn^4}.
  \label{eq:trunc-implicit-form}
\end{align}

Using a geometric series representation we can show that if all eigenvalues of  $-\frac{\dtn}{2}\dfdyhf$ are s.t. $\abs{\lambda} < 1$\cite{??ds} (which will always be true for some ``small enough'' $\dtn$) then
??ds can we divide by the largest eigenvalue somewhere to do this?
\begin{equation}
  (I + \frac{\dtn}{2}\dfdyhf)^{-1} = I - \frac{\dtn \dfdyhf}{2}  \porder{\dtn^2},
\end{equation}
and so\footnote{Assuming that $\dfdyhf$ is not inversely proportional to $\dtn$.}
\begin{equation}
  \lte^\IMP = \frac{\dtn^3}{24} \left[\yvhf['''] - 3 \dfdyhf \cdot \yvhf[''] \right]
  \quad +\order{\dtn^4}.
  \label{eq:trunc-final}
\end{equation}



\section{Application of the adaptive implicit midpoint rule to micromagnetics}

%*** Banas' work

\subsection{Why use the implicit midpoint rule}

Implicit midpoint rule is known to be especially effective for micromagnetics problems \cite{DAquino2005}.
The non-dimensionalised form of the Landau-Lifshitz equation is
\begin{equation}
  \label{eq:llg-prop-form}
  \dmdt = - \mv \times( \hv - \dampc \dmdt),
\end{equation}
where $\hv$ is the effective field due to various effects depending on the system being modelled.
It is mathematically equivalent to the Landau-Lifshitz equation (as used elsewhere) with different constants, however certain properties are easier to prove with this Gilbert form so we will use it for this section.

It has certain properties:
\begin{itemize}
\item conserves magnetisation length
\item dissipates energy at a rate determined by alpha (as defined by a Rayleigh dissipation functional)
\item conserves energy at zero damping.
\end{itemize}

Clearly it is advantageous for a time discretisation method to preserve these properties.
IMR conserves them (demonstrated below), most other time discretisation schemes don't.

Errors in both of these conservation properties have been used as an error estimator for the entire error.
Hence it seems likely that reducing these errors will reduce the total error.

Geometric (or symplectic) integration schemes typically result in much smaller error build-up than schemes that do not preserve such quantities.


In addition to these properties IMR is:
\begin{itemize}
\item second order accurate -- typically considered good enough for pdes (higher orders would require expensive high order spatial discretisation to be effective, generally better to just do h-refinement instead) \cite{Matthias}
\item ??ds-stable - think it's A-stable? \cite{??ds} -- so appropriate for stiff problems, llg is stiff in some/most cases\cite{??ds}.
\end{itemize}

However it might suffer from order reduction ??ds Read more about implicit runge kutta etc?

Since IMR is a single step method there is no dependence on $\dtx{n-1}$ (unlike, for example, BDF2) and so no change in these properties would be expected when going from fixed to varying time step sizes.

\subsection{Properties of continuous Landau-Lifshitz-Gilbert equation}
\label{sec:prop-cont-llg}

We will use the identity
\begin{equation}
  \label{eq:dot-cross-id}
  \ip{\av}{\av \times \bv} = 0,
\end{equation}
which is true for all inner products because $\av \times \bv$ is perpendicular to $\av$ by the definition of the cross product.

Conservation of magnetisation length can be shown by taking the dot product (scalar product, pointwise inner product) with $\mv$ on both sides of~\eqref{eq:llg-prop-form} and using~\eqref{eq:dot-cross-id} to get
\begin{equation}
  \label{eq:56}
  \mv \cdot \dmdt = 0.
\end{equation}
Hence the change in $\mv$ is always perpendicular to $\mv$ so length is conserved.

The energy change properties can be examined similarly by taking the $L^2$ inner product
\begin{equation}
  \ip{u}{v} = \int_\magd u v \d\magd
\end{equation}
with $\hv - \dampc \dmdt$ on both sides of~\eqref{eq:llg-prop-form} and using the identity~\eqref{eq:dot-cross-id} to get
\begin{equation}
  \label{eq:58}
  \ip{\hv}{\dmdt} - \dampc \ip{\dmdt}{\dmdt} = 0.
\end{equation}
Using the fact that $\hv = -\vd{\e}{\mv}$ and the chain rule for variational derivatives\cite{??ds} we get
\begin{align*}
  \pd{\e[\mv(\xv, t), t]}{t} &= \ip{\vd{e}{\mv}}{\dmdt} - \ip{\pd{\happ}{t}}{\mv} \\
             &= -\ip{\hv}{\dmdt} - \ip{\pd{\happ}{t}}{\mv},
\end{align*}
and so
\begin{equation}
  \ip{\hv}{\dmdt} = -\vd{\e}{t} - \ip{\pd{\happ}{t}}{\mv}.
\end{equation}

Substituting this into equation~\eqref{eq:58} leaves
\begin{equation}
  \label{eq:energy-decay}
  \vd{\e}{t} = -\dampc \ip{\dmdt}{\dmdt} - \ip{\pd{\happ}{t}}{\mv}.
\end{equation}

Equation~\eqref{eq:energy-decay} shows that under constant applied field the energy of the system is always decreasing by an amount proportional to $\dampc$.
In fact this relationship is the Rayleigh dissipation functional used as the basis for the derivation of the Gilbert form of the LLG.\cite{Gilbert2004}
For non-constant applied fields the change in the Zeeman energy is added which may increase or decrease the energy depending on how the field is changed. % field moves towards m -> decrease, away -> increase. For non-spatially constant this is averaged over space in some sense by the inner product.


\subsection{Properties of midpoint method LLG discretisation}
\label{sec:prop-midp-meth}

??ds discuss which inner products/norms are used where

As noted in Section~\ref{sec:extens-impl-odes} IMR is defined by the following substitutions
\begin{align}
  \label{eq:55}
  \pd{\mv}{t} &= \frac{\mv_{n+1} - \mv_n}{\dtn}, \\
  \mv &= \frac{\mv_{n+1} + \mv_n}{2}, \\
  t &=  \frac{t_{n+1} + t_n}{2}.
\end{align}

The special conservation properties of IMR discretisation of the Landau-Lifshitz-Gilbert equation come from the fact that for any symmetrical linear operator $\ell$
\begin{align}
  \label{eq:54}
  \ip{\ell \left[ \mv_{n+\half} \right]}{ \pd{\mv}{t} \lvert_{n+\half}}
  &= \frac{1}{2\dtn} \left[
    (\mv_{n+1} , \ell \mv_{n+1})
    + (\mv_{n+1} , \ell \mv_{n})
    - (\mv_{n} , \ell \mv_{n+1})
    - (\mv_{n} , \ell \mv_{n})
    \right] \notag\\
  &= \frac{1}{2\dtn} \left[
    (\mv_{n+1} , \ell \mv_{n+1})
    - (\mv_{n} , \ell \mv_{n})
    \right].
\end{align}

In particular for the identity operator, $\mv \in \real$ and $(\av, \bv) = \av \cdot \bv$ we have
\begin{equation}
  \label{eq:52}
  \mv \cdot \pd{\mv}{t}  = \frac{1}{2\dtn} (\norm{\mv_{n+1}}^2 - \norm{\mv_{n}}^2 ).
\end{equation}
Substituting this into equation~\eqref{eq:56} gives
\begin{equation}
  \abs{\mv_{n+1} }^2 - \abs{\mv_{n}}^2 = 0 \quad \forall \xv \in \magd
\end{equation}
\ie conservation of magnetisation length.

??ds operators below need checking, dAquino is only concerned with FD...

The time-discretised effective field can be represented as a symmetrical linear operator on magnetisation:\cite{DAquino2005}
\begin{equation}
  \label{eq:hop}
  \hv_n(\xv) = \hop [\mv_n(\xv)] + \happ(\xv, t_n).
\end{equation}
Additionally the energy can be written using this operator as
\begin{equation}
  \label{eq:energy-hop}
  \e_n = \frac{1}{2} \ip{\mv_n}{\hop[\mv_n] + \happ(\xv,t_n)}.
\end{equation}

Substituting the midpoint approximation and equation~\eqref{eq:hop} into \eqref{eq:58} leaves
\begin{align}
  \label{eq:60}
  &\ip{ \pd{\mv}{t} \lvert_{n+\half}}{\hop \left[\mv_{n+\half} \right]} + \ip{\frac{\mv_{n+1} - \mv_n}{\dtn}}{\happ(\xv,t_{n+\half})} \\
  &= \dampc \ip{\frac{\mv_{n+1} - \mv_n}{\dtn}}{\frac{\mv_{n+1} - \mv_n}{\dtn}}.
\end{align}
We use a midpoint approximation for the applied field to allow us to cancel terms later:
\begin{equation}
  \label{eq:happ-midpoint}
  \happ(\xv,t_{n+\half}) = \frac{\happ(\xv, t_{n+1}) + \happ(\xv, t_n)}{2} + \order{\dtn^2 \spd{\happ}{t}}.
\end{equation}
Combining equations~\eqref{eq:60}, \eqref{eq:happ-midpoint} and the identity~\eqref{eq:54} gives us
\begin{align}
  &\frac{\ip{\mv_{n+1}}{\hop \left[\mv_{n+1} \right] + \happ(\xv, t_{n+1})}
    - \ip{\mv_{n}}{\hop \left[\mv_{n} \right] + \happ(\xv, t_n)}
    }{2\dtn} \notag\\
  &= \dampc \norm{\frac{\mv_{n+1} - \mv_n}{\dtn}}^2
  + \order{\dtn^2 \spd{\happ}{t}}.
\end{align}
After substitution of the energy from~\eqref{eq:energy-hop} this leaves
\begin{equation}
  \frac{\e_{n+1} - \e_n}{\dtn}
  = \dampc \norm{\frac{\mv_{n+1} - \mv_n}{\dtn}}^2
  + \order{\dtn^2 \spd{\happ}{t}}.
\end{equation}
Hence with (piecewise) linear applied fields the energy loss is exactly correct.

It should be noted that the above properties are only true up to the accuracy with which we solve the LLG. Since the LLG is non-linear this is typically the Newton tolerance.


\subsection{Numerical Experiments}

In this section we present numerical experiments showing that the adaptive midpoint method retains the conservation properties of the fixed step midpoint method.
For this purpose we choose a simple model: a small\footnote{Small enough that exchange coupling dominates and the magnetisation is spatially constant throughout the particle.} spherical nano-particle with no magnetocrystalline anisotropy under linearly increasing applied field.
In this case
\begin{equation}
  \hv(t) = - t/2 +  \frac{\mv}{3}.
\end{equation}
The initial magnetisation used is $\mv_0 = \left( 0.05, 0, \sqrt{1 - 0.05^2} \right)$.
The damping constant is $\dampc = 0.3$.
The Newton tolerance is $1\E{-8}$ and the adaptive integrator tolerance is $\toltt = 1\E{-4}$ unless otherwise specified.

Figure~\ref{fig:linear-field-switch-mp} shows again that the adaptivity works: initially the field is so weak that not much is happening and large steps are taken.
Then the switching speeds up and the step size gradually decreases.
Finally the switching is finished and the step size increases again.

\begin{figure}[ht!]
  \centering
  \includegraphics{images/placeholder}
  \caption{Magnetisation dynamics and step size selections for a small spherical magnetic nano-particle switching in a linearly increasing applied field. Calculated using the adaptive midpoint method with two interpolation points.}
  \label{fig:linear-field-switch-mp}
\end{figure}

Figure~\ref{fig:linear-field-switch-errors-mp} shows that the adaptive midpoint method gives orders of magnitude better accuracy than adaptive BDF2 in magnetisation length and effective damping, as expected.
Of interest is the noise in the midpoint effective damping error between $t \approx 2.5$ and $t \approx 9$.
This is caused by strong variation in the final Newton error: since Newton's method gives quadratic convergence one additional step results in orders of magnitude more accuracy.
This also indicates that the errors are strongly related to the Newton solver error, which is as expected since this is the only source of error (in these quantities) which is not removed by the use of IMR.

??ds also do fixed step midpoint?

\begin{figure}[ht!]
  \centering
  \includegraphics{images/placeholder}
  \caption{Comparison of errors in $\abs{\mv}$ and $\dampc$ for adaptive midpoint method and adaptive BDF2 for a small spherical magnetic nano-particle switching in a linearly increasing applied field.}
  \label{fig:linear-field-switch-errors-mp}
\end{figure}


To investigate this effect further we compare the average errors for various Newton tolerances in Figure~\ref{fig:newton-tol-errors-mp}.
It can be seen that reduction of the Newton tolerance strongly reduces the mean errors.

\begin{figure}[ht!]
  \centering
  \includegraphics{images/placeholder}
  \caption{Effect of varying the Newton method tolerance on errors in $\abs{\mv}$ and $\dampc$  for the switching nano-particle problem discussed above.}
  \label{fig:newton-tol-errors-mp}
\end{figure}


\subsection{Discussion}

\subsubsection{Extension to pdes}

We have done some initial work using adaptive midpoint for the non-spatially constant LLG (\ie a pde) which works well for fully implicit problems.

Unfortunately the energy/damping conservation properties require the entire calculation to be performed implicitly.
This is incompatible with the semi-implicit FEM/BEM method for magnetostatic field calculations,\cite{Koehler1997} which is used in the current implementation of our model.
However d'Aquino \etal demonstrated an efficient, fully implicit finite difference LLG solver using the fixed step midpoint method\cite{DAquino2005}.
Such a solver should be easily to modifiable to use our adaptive midpoint method.

The conservation of magnetisation length by IMR does not require a fully implicit calculation as demonstrated by Spargo \etal\cite{Spargo2003a}.
Hence the adaptive midpoint method could be used to construct a semi-implicit magnetisation-length-conserving scheme with purely numerical time adaptivity, with the advantages discussed in Section~\ref{sec:altern-time-adapt}.


\subsubsection{Alternative time adaptivity methods in micromagnetics}
\label{sec:altern-time-adapt}

In cases where the damping is not exact the effective damping can be used as an error estimator, as proposed by Albuquerque \etal\cite{Albuquerque2001}
??ds The disadvantage of this method (aside from the obvious requirement that the damping be inexact) is that, depending on the discretisation used, the error estimator may be unable to distinguish between insufficient space refinement and insufficient time refinement.
In particular this is the case when the solution is not completely divided into separate effective field calculations and pointwise time integration, such as in a typical Galerkin finite element model.

Rigorous time error estimates for the LLG with limited effective field terms with a certain discretisation method were proven and used to perform adaptive refinement of midpoint method time steps by Banas.\cite{Banas-thesis} ??ds do these work, why does no one use them?
By comparison our adaptive method is much more general in that it can be applied to any differential equation and any discretisation scheme which uses the method of lines for time.

\subsubsection{Symplecity}

??ds I basically have no idea about this stuff.

The fixed step midpoint method is ``almost symplectic'' for the LLG equation with zero damping (Hamiltonian structure is preserved up to a small error).\cite{Austin1993}
However it is well known that most adaptive schemes are not symplectic\cite{Iserles2009} % pg. 91
because they constantly change the nearby Hamiltonian that is followed by the symplectic integrator.

??ds MORE


\subsection{Future work}

%*** Does adaptivity trail off eventually like trapazoid?

Testing with pdes.



%%% Local Variables:
%%% mode: latex
%%% TeX-master: "./main"
%%% End:
