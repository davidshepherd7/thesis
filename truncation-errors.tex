\chapter{Truncation error derivation for IMR}
\label{sec:full-imr-lte-calculation}

% \begin{table}[h]
%   \centering
%   \begin{tabular}{c|c}
%     TR & $\frac{1}{12} \approx 0.0833$ \\
%     BDF2 & $\frac{2}{9} \approx 0.2222$ \\
%     IMR & complex, as TR for linear problems
%   \end{tabular}
%   \caption{Magnitude of the constant in front of leading order term of truncation errors for constant time step size.}
%   \label{tab:truncation-errors}
% \end{table}

% \section{Trapezoid Rule}

% Expression from \cite[261]{GreshoSani}
% \begin{equation}
%   \label{eq:tr-lte-conststep}
%   \lte = \yv_{n+1} - \yv(t_{n+1}) = -\frac{\dtn^3 \yv_n'''}{12}
%   + \order{\dtn^4}.
% \end{equation}

% \section{BDF2}

% Expression from \cite[715]{GreshoSani} or \cite[eq. (2.43)]{Prinja2010}
% \begin{equation}
%   \label{eq:bdf2-lte-appendix}
%   \lte = \yv_{n+1} - \yv(t_{n+1}) = \frac{(\dtn + \dtx{n-1})^2}{\dtn(2\dtn + \dtx{n-1})}
%   \frac{\dtn^3 \yv_n'''}{6}
%   + \order{\dtn^4}.
% \end{equation}

% With constant time steps this reduces to
% \begin{equation}
%   \label{eq:bdf2-lte}
%   \lte = \yv_{n+1} - \yv(t_{n+1}) =  \frac{2\dtn^3 \yv_n'''}{9}
%   + \order{\dtn^4}.
% \end{equation}

% \section{IMR}
% \label{sec:full-imr-lte-calculation}

Continuing from \cref{eq:trunc-mid} at the end of \cref{sec:deriv-local-trunc}.

In order to be able to cancel terms we now need to Taylor expand $\fv\left( \thf, \frac{\yv(t_n) + \yv_{n+1}}{2} \right)$ in $\yv$ about $\yvhf$.
Hence we need an expansion of the form
\begin{equation}
  \begin{aligned}
    \fv(\thf, \frac{\yv(t_n) + \yv_{n+1}}{2}) &= \fv(\thf, \yvhf + \dyn), \\
    &= \fv(\thf, \yvhf) + \dfdyhf \cdot \dyn  + \order{\dyn^2},
    \label{eq:f-taylor}
  \end{aligned}
\end{equation}
where $\dfdyhf = \dfdy(\thf, \yvhf)$ is a \emph{matrix} of partial derivatives\footnote{Note that this is \emph{not} equivalent to the Jacobian matrix associated with the Newton-Raphson method which is the derivative of the residual function with respect to each element of $\yv$.} of each element of $\fv$ with respect to each element of the vector $\yv$.
Note that the $\fv$ term is multiplied by an additional factor of $\dtn$ in \cref{eq:trunc-start}, so for this part of the derivation we can drop terms of higher order than $\order{\dtn^2}$ and still retain the same asymptotic accuracy.

We now derive the required correction $\dyn$.
From \cref{eq:f-taylor} we have
\begin{equation}
  \dyn = \frac{\yv(t_n) + \yv_{n+1}}{2} - \yvhf.
  \label{eq:51}
\end{equation}
However we cannot expand $\yv_{n+1}$ to get $\dyn$ in terms of only values at the midpoint.
So we use the LTE of IMR to rewrite \cref{eq:51} as
\begin{equation}
  \dyn = \frac{\yv(t_n) + \yv(t_{n+1}) - \lte^\imr}{2} - \yvhf.
\end{equation}
Substituting in the Taylor expansions for $\yv(t_n)$ and $\yv(t_{n+1})$ about $\thf$ (from equations~\cref{eq:taylornp1,eq:taylorn}) gives
\begin{equation}
  \begin{aligned}
    \dyn &= \yvhf + \frac{\dtn^2}{8} \yvhf[''] - \yvhf - \frac{1}{2} \lte^\imr + \order{\dtn^4},\\
    &= \frac{\dtn^2}{8} \yvhf[''] - \frac{1}{2} \lte^\imr + \order{\dtn^4}.
    \label{eq:dy-value}
  \end{aligned}
\end{equation}


Substituting the above value for $\dyn$ into the Taylor series expansion of $\fv$ from \cref{eq:f-taylor} gives
\begin{equation}
  \fv(\thf, \frac{\yv(t_n) + \yv_{n+1}}{2}) = \yvhf[']
  + \frac{\dtn^2}{8} \dfdyhf \cdot \yvhf[''] - \frac{1}{2} \dfdyhf \cdot \lte^\imr + \order{\dtn^4}
  . \label{eq:fy-taylor}
\end{equation}
and using \cref{eq:fy-taylor} in \cref{eq:trunc-mid} gives the local truncation error
\begin{equation}
  \begin{aligned}
    (I + \frac{\dtn}{2}\dfdyhf) \cdot\lte^\imr
    &= \dtn \yvhf['] + \frac{\dtn^3}{24} \yvhf['''] - \dtn \yvhf['] \\
    &\qquad- \frac{\dtn^3}{8} \dfdyhf \cdot \yvhf[''] + \order{\dtn^4}, \\
    &= \frac{\dtn^3}{24} \left[\yvhf['''] - 3 \dfdyhf \cdot \yvhf[''] \right]
    + \order{\dtn^4}.
    \label{eq:trunc-implicit-form}
  \end{aligned}
\end{equation}

Using a geometric series representation we can show that, if all eigenvalues of  $-\frac{\dtn}{2}\dfdyhf$ are such that $\abs{\lambda} < 1$, then\footnote{If $\dfdyhf$ is not dependent on $\dtn$ then this will always be true for some sufficiently small $\dtn$, the case where $\dfdyhf$ is a function of $\dtn$ is covered in \cref{sec:order-reduction}.} \cite{??ds}
\begin{equation}
  (I + \frac{\dtn}{2}\dfdyhf)^{-1} = I - \frac{\dtn \dfdyhf}{2}  + \order{\dtn^2},
\end{equation}
and so
\begin{equation}
  \lte^\imr = \frac{\dtn^3}{24} \left[\yvhf['''] - 3 \dfdyhf \cdot \yvhf[''] \right]
  \quad +\order{\dtn^4}.
\end{equation}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
